<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js"></script>
    <title>Tree builder</title>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.4/font/bootstrap-icons.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.11/themes/default/style.min.css" />
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/left-panel.css" />


    <link rel="stylesheet" href="./css/utils/TabPanel.css" />

    <link rel="stylesheet" href="./css/utils/ResizibleDiv.css" />


</head>

<body>
    <div id="toolbar"></div>
    <div id="workspace">

        <div id="left-panel">
            <div id="left-panel-toolbar">
                <i class="panel-trigger" data-feather="circle" data-target="data-container"></i>
                <i class="panel-trigger" data-feather="alert-octagon" data-target="editor-container-test"></i>
            </div>
            <div id="left-panel-content">
                <div id="data-container"  class="left-panel-panel active">
                    <div id="jstree-container"></div>
                    <!-- <div id="node-data"></div> -->
                </div>

                <div id="editor-container-test"  class="left-panel-panel">
                    <div id="node-data-test"></div>
                </div>
            </div>
        </div>

        <!-- <div id='tree-container'></div> -->

        <div id="main-content-container">
            <div class="tabs">
                <div class="tab active">Graph</div>
                <div class="tab active">Source</div>
                <div class="tab active">Test</div>
            </div>

            <div class="tab-contents">
                <div id="graph-container" class="tab-content">
                    <div id="graph"></div>
                </div>

                <div id="editor-container"  class="tab-content">
                    <div id="source-editor"></div>
                </div>


                <div id="questionnaire-container"  class="tab-content">
                    <img src="./images/teacher.webp" style="width: 100%" />
                    <div id="questionnaire"></div>
                </div>

            </div>
        </div>

        <div id="right-panel">
            <div id="node-editor-container">
                <div id="node-editor"></div>
                <div>
                    <button id="node-editor-update">Update</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        feather.replace()
    </script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.11/jstree.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.13.5/beautify.min.js"></script>



    <script src="./src/js/TreeOption.js"></script>
    <script src="./src/js/TreeNode.js"></script>
    <script src="./src/js/TreeOptionUI.js"></script>
    <script src="./src/js/TreeNodeUI.js"></script>
    <script src="./src/js/AddNodeForm.js"></script>
    <script src="./src/js/AddOptionForm.js"></script>

    <script src="./src/js/EchartRenderer.js"></script>
    <script src="./src/js/JSTreeRenderer.js"></script>

    <script src="./src/js/QuestionnaireRenderer.js"></script>
    <script src="./src/js/NodeEditor.js"></script>



    <script src="./src/js/utils/Draggable.js"></script>
    <script src="./src/js/utils/Popin.js"></script>
    <script src="./src/js/utils/TabPanel.js"></script>
    <script src="./src/js/utils/ResizibleDiv.js"></script>



    <script>
const myResizableDiv1 = new ResizableDiv('#left-panel');
// const myResizableDiv2 = new ResizableDiv('#main-content-container');

const myTabPanel = new TabPanel('#main-content-container');


// Create an instance of the Popin class
let myPopin = new Popin(500, 300);

// Add content to the popin
myPopin.setContent('Popin content');

// Display the popin on the page
// myPopin.show();

// Close the popin after 5 seconds
setTimeout(() => {
  // myPopin.close();
}, 5000);




        document.querySelectorAll('.panel-trigger').forEach(trigger => {
            trigger.addEventListener('click', (event) => {
                const button = event.currentTarget;
                const targetName = button.dataset.target;

                document.querySelectorAll('.left-panel-panel').forEach((panel) => {
                    panel.classList.remove('active');
                });

                document.getElementById(targetName).classList.add('active');
            });
        });


        // ===========================

        const echartContainer = document.getElementById('graph');
        ace.config.setModuleUrl(
            'ace/mode/json',
            'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-json.js'
        );
        // Activation de la beautification de code
        ace.require("ace/ext/beautify");
        // ===========================

        const tree = new TreeNode();

        const treeUpdate = () => {


            echartRenderer.refresh();

            /*
            sourceEditor.setValue(
                JSON.stringify(data)
            );
            */
        };

        tree.addEventListener('loaded', (data) => {
            treeUpdate(data);
        });


        // ===========================
        const sourceEditor = new NodeEditor("source-editor");
        sourceEditor.setNode(tree);

        // ===========================
        const nodeEditor = new NodeEditor("node-editor");
        document.querySelector('#node-editor-update').addEventListener('click', event => {

            console.log('%cindex.html :: 191 =============================', 'color: #f00; font-size: 1rem');
            console.log(nodeEditor.getValue());
            console.log(nodeEditor.getNode())

            // jsTreeRenderer.updateNodeData();
        });


        // ===========================
        const echartRenderer = new EchartRenderer(echartContainer, tree);
        echartRenderer.addEventListener('click', data => {
            const nodeId = data.id;
            jsTreeRenderer.selectNodeById(nodeId);


        });
        // ===========================

        const jsTreeRenderer = new JSTreeRenderer(tree);
        jsTreeRenderer.render([], '#jstree-container');

        // JDLX_TODO
        jsTreeRenderer.addEventListener('select', node => {
            nodeEditor.setNode(node);
            nodeEditor.refresh();
            // nodeEditor.setValue(JSON.stringify(data));
        });


        jsTreeRenderer.addEventListener('rename', data => {
            treeUpdate();
        });

        jsTreeRenderer.addEventListener('create', data => {
            treeUpdate();
        });

        jsTreeRenderer.addEventListener('delete', data => {
            treeUpdate();
        });
        jsTreeRenderer.addEventListener('move', data => {
            treeUpdate();
        });




        jsTreeRenderer.addEventListener('paste', data => {
            tree.loadData(data);
            treeUpdate(data);
        });



        fetch('./data/developer.json').then((response) => response.json())
            .then(data => {
                tree.loadData(data);

                const treeData = tree.toJSON()

                sourceEditor.refresh();
                jsTreeRenderer.refresh();
                echartRenderer.render();

                const questionnaire = new Questionnaire(treeData, document.querySelector('#questionnaire'));
                questionnaire.render();
            });




        // const ui = new TreeNodeUI(tree);
        // document.querySelector('#tree-container').append(ui.render());

        //*/
        /*
        const tree = new TreeNode('Est ce que cet animal vole', null, (node) => {
            const json = JSON.stringify(tree.toJSON());
            const data = tree.toJSON();

            console.log('%cindex.html :: 42 =============================', 'color: #f00; font-size: 1rem');
            console.log(data);
            console.log(json);
            echartRenderer.render(container, tree);

            jsTreeRenderer.loadData(data);

            // console.log('%cindex.html :: 61 =============================', 'color: #f00; font-size: 1rem');
            // console.log(jsTreeRenderer.exportToTreeNode());
        });


        const yes = tree.createOption(1, 'Oui');
        tree.createOption(0, 'Non');
        tree.createOption(-1, 'Passer');


        const hasFeather = yes.setChild(
            new TreeNode('Est ce cet animal Ã  des plumes')
        );

        hasFeather.createOption(1, 'Oui');
        hasFeather.createOption(0, 'Non');

        //*/
    </script>

</body>

</html>